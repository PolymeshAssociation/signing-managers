name: release

on:
  push:
    branches: [main, beta, alpha]

jobs:
  lint-and-test:
    name: Linting and testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
      - name: install dependencies
        run: yarn --frozen-lockfile
      - name: lint and test
        uses: mansagroup/nrwl-nx-action@v3
        with:
          targets: lint,test
  release:
    name: Building and releasing project
    runs-on: ubuntu-latest
    needs: ['lint-and-test']
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          registry-url: "https://registry.npmjs.org"
      - name: Setup Git
        run: |
          git config user.name "Eric Richardson"
          git config user.email "eric@polymesh.network"
      - name: install dependencies
        run: yarn --frozen-lockfile
      - name: build and release
        run: |
         yarn nx run @polymeshassociation/azure-signing-manager:semantic-release
        # TODO use: yarn nx run-many --all --target=semantic-release --parallel=false

        env:
          CI: true
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.ASSOCIATION_NPM_TOKEN }}